<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Enabling Data Purge - </title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <base href="../../">

        <link rel="stylesheet" href="book.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">

        <!-- MathJax -->
        <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Fetch JQuery from CDN but have a local fallback -->
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script>
            if (typeof jQuery == 'undefined') {
                document.write(unescape("%3Cscript src='jquery.js'%3E%3C/script%3E"));
            }
        </script>
    </head>
    <body class="light">
        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme = localStorage.getItem('theme');
            if (theme == null) { theme = 'light'; }
            $('body').removeClass().addClass(theme);
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var sidebar = localStorage.getItem('sidebar');
            if (sidebar === "hidden") { $("html").addClass("sidebar-hidden") }
            else if (sidebar === "visible") { $("html").addClass("sidebar-visible") }
        </script>

        <div id="sidebar" class="sidebar">
            <ul class="chapter"><li class="affix"><a href="Home.html">Introduction</a></li><li><a href="1-Sensys/1.1-Overview.html"><strong>1.</strong> Sensys</a></li><li><ul class="section"><li><a href="1-Sensys/1.2-Core-Features.html"><strong>1.1.</strong> Core features</a></li></ul></li><li><strong>2.</strong> Sensys Build and Installation</li><li><ul class="section"><li><a href="2-Build-and-Installation-Guide/2.1-Sensys-Build-and-Installation/2.1.01-Build-Dependencies.html"><strong>2.1.</strong> Build Dependencies</a></li><li><a href="2-Build-and-Installation-Guide/2.1-Sensys-Build-and-Installation/2.1.02-Pre-build-Configuration.html"><strong>2.2.</strong> Pre build Configuration</a></li><li><a href="2-Build-and-Installation-Guide/2.1-Sensys-Build-and-Installation/2.1.03-Build-From-SRPMS.html"><strong>2.3.</strong> Build From SRPMS</a></li><li><a href="2-Build-and-Installation-Guide/2.1-Sensys-Build-and-Installation/2.1.04-Relocate-RPM-Install-Path.html"><strong>2.4.</strong> Relocate RPM Install Path</a></li><li><a href="2-Build-and-Installation-Guide/2.1-Sensys-Build-and-Installation/2.1.05-Build-From-Source-Tar-Files.html"><strong>2.5.</strong> Build From Source Tar Files</a></li><li><a href="2-Build-and-Installation-Guide/2.1-Sensys-Build-and-Installation/2.1.06-Build-From-GitHub-Repo.html"><strong>2.6.</strong> Build From GitHub Repo</a></li><li><a href="2-Build-and-Installation-Guide/2.1-Sensys-Build-and-Installation/2.1.07-Post-build-Configuration.html"><strong>2.7.</strong> Post build Configuration</a></li><li><a href="2-Build-and-Installation-Guide/2.1-Sensys-Build-and-Installation/2.1.08-Setting-Up-pre-requisites-for-RAS-Monitoring.html"><strong>2.8.</strong> Setting Up pre requisites for RAS Monitoring</a></li><li><a href="2-Build-and-Installation-Guide/2.1-Sensys-Build-and-Installation/2.1.09-Startup-Instructions.html"><strong>2.9.</strong> Startup Instructions</a></li><li><a href="2-Build-and-Installation-Guide/2.1-Sensys-Build-and-Installation/2.1.10-Troubleshooting.html"><strong>2.10.</strong> Troubleshooting</a></li><li><a href="2-Build-and-Installation-Guide/2.1-Sensys-Build-and-Installation/2.1.11-Setting-MCA-Parameters.html"><strong>2.11.</strong> Setting MCA Parameters</a></li><li><strong>2.12.</strong> Database Installation</li><li><ul class="section"><li><a href="2-Build-and-Installation-Guide/2.2-Database-Installation/2.2.1-Database-Server.html"><strong>2.12.1.</strong> Database Server</a></li><li><a href="2-Build-and-Installation-Guide/2.2-Database-Installation/2.2.2-Database-Connectivity.html"><strong>2.12.2.</strong> Database Connectivity</a></li><li><a href="2-Build-and-Installation-Guide/2.2-Database-Installation/2.2.3-Enabling-Data-Purge.html" class="active"><strong>2.12.3.</strong> Enabling Data Purge</a></li><li><a href="2-Build-and-Installation-Guide/2.2-Database-Installation/2.2.4-Monitoring-Database-Size.html"><strong>2.12.4.</strong> Monitoring Database Size</a></li><li><a href="2-Build-and-Installation-Guide/2.2-Database-Installation/2.2.5-Database-Distro-Specific-Examples.html"><strong>2.12.5.</strong> Database Distro Specific Examples</a></li><li><a href="2-Build-and-Installation-Guide/2.2-Database-Installation/2.2.6-Database-ZeroMQ-Publishing.html"><strong>2.12.6.</strong> Database ZeroMQ Publishing</a></li></ul></li></ul></li><li><strong>3.</strong> Sensys User Guide</li><li><ul class="section"><li><a href="3-Sensys-User-Guide/3.1-Overview.html"><strong>3.1.</strong> Overview</a></li><li><a href="3-Sensys-User-Guide/3.2-orcmd.html"><strong>3.2.</strong> orcmd</a></li><li><a href="3-Sensys-User-Guide/3.3-orcmsched.html"><strong>3.3.</strong> orcmsched</a></li><li><a href="3-Sensys-User-Guide/3.4-Sensys-CFGI-User-Guide.html"><strong>3.4.</strong> Sensys CFGI User Guide</a></li><li><a href="3-Sensys-User-Guide/3.5-Sensys-Regex.html"><strong>3.5.</strong> Sensys Regex</a></li><li><a href="3-Sensys-User-Guide/3.6-Sensys-Logical-Grouping.html"><strong>3.6.</strong> Sensys Logical Grouping</a></li><li><a href="3-Sensys-User-Guide/3.7-octl.html"><strong>3.7.</strong> octl</a></li><li><a href="3-Sensys-User-Guide/3.8-RAS-Monitoring.html"><strong>3.8.</strong> RAS Monitoring</a></li><li><a href="3-Sensys-User-Guide/3.9-Data-Smoothing-Algorithms-Analytics.html"><strong>3.9.</strong> Data Smoothing Algorithms Analytics</a></li><li><a href="3-Sensys-User-Guide/3.10-ErrorManager-Notification.html"><strong>3.10.</strong> ErrorManager Notification</a></li><li><a href="3-Sensys-User-Guide/3.11-Diagnostics.html"><strong>3.11.</strong> Diagnostics</a></li><li><a href="3-Sensys-User-Guide/3.12-Sensys-Security-Aspects.html"><strong>3.12.</strong> Sensys Security Aspects</a></li><li><a href="3-Sensys-User-Guide/3.13-Sensys-Database-Multiple-Threads.html"><strong>3.13.</strong> Sensys Database Multiple Threads</a></li><li><a href="3-Sensys-User-Guide/3.14-Sensys-Database-Multi-Select.html"><strong>3.14.</strong> Sensys Database Multi Select</a></li></ul></li><li><strong>4.</strong> Developer Guide</li><li><ul class="section"><li><a href="4-Developer-Guide/4.1-Sensys-DB-Framework-API/4.1.1-DB-Framework-API-Design.html"><strong>4.1.</strong> DB Framework API Design</a></li><li><a href="4-Developer-Guide/4.1-Sensys-DB-Framework-API/4.1.2-DB-Framework-API.html"><strong>4.2.</strong> DB Framework API</a></li><li><a href="4-Developer-Guide/4.2-Sensys-DB-API/4.2.1-DB-API.html"><strong>4.3.</strong> DB API</a></li><li><a href="4-Developer-Guide/4.3-Sensys-DB-Schema/4.3.1-DB-Schema-V2,0.html"><strong>4.4.</strong> DB Schema V2,0</a></li><li><a href="4-Developer-Guide/4.4-Sensys-Simplified-Analytics-Interface/4.4.1-Analytics-Plugin-API.html"><strong>4.5.</strong> Analytics Plugin API</a></li><li><a href="4-Developer-Guide/4.4-Sensys-Simplified-Analytics-Interface/4.4.2-Analytics-Plugin-Development.html"><strong>4.6.</strong> Analytics Plugin Development</a></li><li><a href="4-Developer-Guide/4.4-Sensys-Simplified-Analytics-Interface/4.4.3-Analytics-Plugin-Build-Install.html"><strong>4.7.</strong> Analytics Plugin Build Install</a></li><li><a href="4-Developer-Guide/4.5-Sensys-Simplified-Sensor-Interface/4.5.1-Sensor-Plugin-API.html"><strong>4.8.</strong> Sensor Plugin API</a></li><li><a href="4-Developer-Guide/4.5-Sensys-Simplified-Sensor-Interface/4.5.2-Sensor-Plugin-Development.html"><strong>4.9.</strong> Sensor Plugin Development</a></li><li><a href="4-Developer-Guide/4.5-Sensys-Simplified-Sensor-Interface/4.5.3-Sensor-Plugin-Build-Install.html"><strong>4.10.</strong> Sensor Plugin Build Install</a></li><li><a href="4-Developer-Guide/4.6-dataContainer-reference.html"><strong>4.11.</strong> <code>dataContainer</code> class reference</a></li></ul></li><li><strong>5.</strong> Testing</li><li><ul class="section"><li><a href="5-Testing/5.1-Docker/5.1.1-Centos-Docker-Guide.html"><strong>5.1.</strong> Centos Docker Guide</a></li><li><a href="5-Testing/5.1-Docker/5.1.2-Multihost-Docker.html"><strong>5.2.</strong> Multihost Docker</a></li><li><a href="5-Testing/5.1-Docker/5.1.3-Cluster-Docker.html"><strong>5.3.</strong> Cluster Docker</a></li></ul></li><li><strong>6.</strong> Appendix</li><li><ul class="section"><li><a href="Appendix/A.1-Terminology.html"><strong>6.1.</strong> Terminology</a></li><li><a href="Appendix/A.2-Sensys-Governance-Model/A.2.1-Following-the-Open-MPI-Model.html"><strong>6.2.</strong> Following the Open MPI Model</a></li><li><a href="Appendix/A.2-Sensys-Governance-Model/A.2.2-Contributing-to-the-Source-Code.html"><strong>6.3.</strong> Contributing to the Source Code</a></li><li><a href="Appendix/A.2-Sensys-Governance-Model/A.2.3-Development-Process.html"><strong>6.4.</strong> Development Process</a></li><li><a href="Appendix/A.2-Sensys-Governance-Model/A.2.4-Roles-and-Responsibilities.html"><strong>6.5.</strong> Roles and Responsibilities</a></li><li><a href="Appendix/A.2-Sensys-Governance-Model/A.2.5-Filing-Issues.html"><strong>6.6.</strong> Filing Issues</a></li><li><a href="Appendix/A.3-Maintaining-the-Wiki.html"><strong>6.7.</strong> Maintaining the Wiki</a></li></ul></li></ul>
        </div>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar" class="menu-bar">
                    <div class="left-buttons">
                        <i id="sidebar-toggle" class="fa fa-bars"></i>
                        <i id="theme-toggle" class="fa fa-paint-brush"></i>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <i id="print-button" class="fa fa-print" title="Print this book"></i>
                    </div>
                </div>

                <div id="content" class="content">
                    <a class="header" href="2-Build-and-Installation-Guide/2.2-Database-Installation/2.2.3-Enabling-Data-Purge.html#enabling-data-purge" id="enabling-data-purge"><h1>Enabling data purge</h1></a>
<p>This section provides instructions on how to automate data purging when using PostgreSQL.  Specifically, on the table with high growing tuple count (e.g. the <code>data_sample_raw</code> table).</p>
<p>The same pattern and technique can be translated to another database dialect, but the code is Postgres specific.  Also the scripts mentioned in this step are available in the Sensys repository <code>contrib/database</code> directory.</p>
<a class="header" href="2-Build-and-Installation-Guide/2.2-Database-Installation/2.2.3-Enabling-Data-Purge.html#background-on-sensys-data-purging-requirement" id="background-on-sensys-data-purging-requirement"><h2>Background on Sensys Data Purging Requirement</h2></a>
<p>The Sensys process is often configured to continuously collect and store data to the database.  Depending on the configuration, these data can grow rapidly and unbounded.  Hence, there need to be a way to purge out the old data.</p>
<p>Please note, data archive, if interested, should be done before purging data.  Once the data is purge, it is gone from the database.  The Sensys PostgreSQL schema (<code>orcmdb_psql.sql</code>) provides two ways to pure out data (based on timestamp attribute):</p>
<ul>
<li>A stored procedure to delete data after certain time interval from current time</li>
<li>A trigger based partition with dropping partitions that has exceeded certain time interval from the timestamp of the latest tuple</li>
</ul>
<p>Each of these will be shown in detail on how to deploy in the following sections.</p>
<a class="header" href="2-Build-and-Installation-Guide/2.2-Database-Installation/2.2.3-Enabling-Data-Purge.html#purging-with-purge_data-function" id="purging-with-purge_data-function"><h2>Purging with 'purge_data()' Function</h2></a>
<p>The <code>purge_data()</code> function provides the simple way to deleting data after the specified time interval from current time.  At the high level, this function resolves an SQL DELETE statement:</p>
<pre><code class="language-sql">DELETE FROM table_name WHERE timestamp_column &lt; CURRENT_TIMESTAMP - interval '&lt;interval_number&gt; &lt;interval_unit&gt;';
</code></pre>
<p>Below is an example of the SQL statement invocation of the <code>purge_data()</code> function.  This statement would DELETE all rows in the <code>data_sample_raw</code> table WHERE <code>time_stamp</code> column having value of less than 6 months from the current time.</p>
<pre><code class="language-sql">SELECT purge_data('data_sample_raw', 'time_stamp', 6, 'MONTH');
</code></pre>
<p>The SQL statement example above can be schedule to run on a regular basis using pgAgent.  Alternative, the statement can also be executed as a shell script using <code>psql</code> tool.  It then can easily be scheduled to run on a regular basis using any schedule tool such as <code>crontab</code>.</p>
<pre><code>$ psql -U username -d database -c &quot;SELECT purge_data('data_sample_raw', 'time_stamp', 6, 'MONTH');&quot;
</code></pre>
<a class="header" href="2-Build-and-Installation-Guide/2.2-Database-Installation/2.2.3-Enabling-Data-Purge.html#purging-with-dropping-partition" id="purging-with-dropping-partition"><h2>Purging with Dropping Partition</h2></a>
<p>Another way to purge data is to DROP the table rather than DELETE tuple from a table as in how the <code>purge_data()</code> function works.  We do not want to DROP the whole table, but only a section of the table.  There is no such thing as DROP a section of a table; However, DROP of a table partition is possible.  So for this to work, we will first enable partition on the table and DROP any out dated partition.</p>
<p>Below is the detail instruction on how to enable partition on a given table with and without the helper script.</p>
<a class="header" href="2-Build-and-Installation-Guide/2.2-Database-Installation/2.2.3-Enabling-Data-Purge.html#partition-without-helper-psql" id="partition-without-helper-psql"><h3>Partition without Helper (psql)</h3></a>
<p>The steps in this section involve invoking PostgreSQL functions.  If you are not comfortable with SQL, see the next section on how to perform this task with the helper script.</p>
<p>Note, running the <code>generate_partition_triggers_ddl()</code> will only output the DDL code to enable partition.  It will not make any change to the database.  Also a few things to be aware when calling this function:</p>
<ul>
<li>Within a GUI application such as pgAdminIII, the result may be truncated, so be sure to set it to allow longer length of characters in the return result.</li>
<li>From the command line such as <code>psql</code> the result is displayed as</li>
</ul>
<p>Below is an example of the SQL statement invocation on the generated partition code for the <code>data_sample_raw</code> table on the <code>time_stamp</code> column by DAY and keep the last 180 partitions.</p>
<ol>
<li>
<p>Generate the partition DDL (data definition language) code.</p>
<pre><code class="language-sql">SELECT generate_partition_triggers_ddl('data_sample_raw', 'time_stamp', 'DAY', 180)';
</code></pre>
</li>
<li>
<p>Review the generated code from the output above.  Note, some GUI tool may be set to limit the length of the string in the result.  Check the GUI setting or run from command line interface (psql) to get the complete generated code.</p>
</li>
<li>
<p>Turn on auto dropping old partition by uncomment the <code>-- EXECUTE('DROP TABLE...</code> statement within the generated code.  By default, the generated DROP TABLE statement is commented out.</p>
</li>
<li>
<p>Execute the modified and reviewed version of the generated code</p>
</li>
</ol>
<a class="header" href="2-Build-and-Installation-Guide/2.2-Database-Installation/2.2.3-Enabling-Data-Purge.html#partition-with-helper-script" id="partition-with-helper-script"><h3>Partition with Helper Script</h3></a>
<p>The same process can be done using <code>pg_partition_helper.py</code>, a python helper script that would perform the step above.  This pythons script uses SQLAlchemy to connect to the PostgreSQL database and execute the SQL DML (data manipulation language) and DDL.  For this to work, the system needs to have the following python modules installed:</p>
<ul>
<li>SQLAlchemy - Database Abstraction Library</li>
</ul>
<pre><code>% pip install --upgrade SQLAlchemy`
</code></pre>
<ul>
<li>psycopg2 - Python-PostgreSQL, also the default PostgreSQL driver used by SQLAlchemy</li>
</ul>
<pre><code>% pip install psycopg2
</code></pre>
<p>Because this helper script uses SQLAlchemy to connect to the database, the database connection string will need to be in the format of <a href="http://docs.sqlalchemy.org/en/latest/core/engines.html#database-urls">SQLAlchemy database URL syntax</a></p>
<p>The helper script expects the PostgreSQL database URL to be stored in the environment variable named <code>PG_DB_URL</code> or passed to it with the <code>--db-url</code> option, see example below on how to set it.</p>
<pre><code>$ export PG_DB_URL=postgresql://[username[:password]]@host[:port]/database
</code></pre>
<p>The helper script has two commands:  enable and disable partition.  Use <code>-h</code> or <code>--help</code> to get usage syntax.  Below is an example of enabling trigger based partition for the <code>data_sample_raw</code> table on the <code>time_stamp</code> column by DAY and keeping the last 10 partitions (based on the timestamp of the new tuple).</p>
<pre><code>$ export PG_DB_URL=postgresql://[username[:password]]@host[:port]/database
$ python pg_partition_helper.py enable data_sample_raw time_stamp DAY --interval-to-keep 10
</code></pre>
<p>Example of disable partition for the <code>data_sample_raw</code> table.</p>
<pre><code>$ export  PG_DB_URL=postgresql://[username[:password]]@host[:port]/database
python pg_partition_helper.py disable data_sample_raw
</code></pre>
<a class="header" href="2-Build-and-Installation-Guide/2.2-Database-Installation/2.2.3-Enabling-Data-Purge.html#managing-partitions" id="managing-partitions"><h3>Managing Partitions</h3></a>
<p>Table partitioning in PostgreSQL database is based on table inheritance.  Each new partition of a main table is a whole new table that inherits the schema of the main table.  In the examples above, <code>data_sample_raw</code> is the main table that does not hold any record.  All records are stored in its corresponding partition.  When querying data from the main table, <code>data_sample_raw</code>, PostgreSQL automatic queries the data from the partitioned tables.  This can be verified using PostgreSQL <code>EXPLAIN</code> statement.</p>
<p>Partition can be un-linked from the main table (no longer a part of the main table), this effectively provides an archive mechanism, or it can be DROPPED from the schema.  Below is an example of breaking the inheritance for the <code>data_sample_raw_20150701_time_stamp</code> partition from the main table <code>data_sample_raw</code>.</p>
<pre><code class="language-sql">ALTER TABLE data_sample_raw_20150701_time_stamp NO INHERIT data_sample_raw;
</code></pre>
<a class="header" href="2-Build-and-Installation-Guide/2.2-Database-Installation/2.2.3-Enabling-Data-Purge.html#recommendation" id="recommendation"><h2>Recommendation</h2></a>
<p>The simple <code>purge_data()</code> function ultimately is an SQL DELETE statement.  The process of deleting records usually involves some logging as the overhead.  In contrast to deleting records, dropping the whole partition of a table is close to instantaneous (i.e. quick format).  However, this requires partitioning a table in order to have partition to drop.  Partition of a table in turn incurs a cost of executing a trigger to route each new tuple to the respective partition, but it provides many other benefits beside able to drop the whole partition.</p>
<p>The recommendation is to use the <code>purge_data()</code> approach as this may already be sufficient for the data purging.  The data partitioning approach is better for archive and potentially improve performance on accessing the data since the data is 'partitioned' to different tables.</p>

                </div>

                <!-- Mobile navigation buttons -->
                
                    <a href="2-Build-and-Installation-Guide/2.2-Database-Installation/2.2.2-Database-Connectivity.html" class="mobile-nav-chapters previous">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="2-Build-and-Installation-Guide/2.2-Database-Installation/2.2.4-Monitoring-Database-Size.html" class="mobile-nav-chapters next">
                        <i class="fa fa-angle-right"></i>
                    </a>
                

            </div>

            
                <a href="2-Build-and-Installation-Guide/2.2-Database-Installation/2.2.2-Database-Connectivity.html" class="nav-chapters previous" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-left"></i>
                </a>
            

            
                <a href="2-Build-and-Installation-Guide/2.2-Database-Installation/2.2.4-Monitoring-Database-Size.html" class="nav-chapters next" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-right"></i>
                </a>
            

        </div>


        <!-- Local fallback for Font Awesome -->
        <script>
            if ($(".fa").css("font-family") !== "FontAwesome") {
                $('<link rel="stylesheet" type="text/css" href="_FontAwesome/css/font-awesome.css">').prependTo('head');
            }
        </script>

        <!-- Livereload script (if served using the cli tool) -->
        

        <script src="highlight.js"></script>
        <script src="book.js"></script>
    </body>
</html>
